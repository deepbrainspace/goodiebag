name: âš™ï¸ Build

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  # Check if this is a release branch
  check-release:
    name: ğŸ” Check Release Branch
    runs-on: ubuntu-latest
    outputs:
      is-release: ${{ steps.check.outputs.is-release }}
    steps:
      - name: Check if release branch
        id: check
        run: |
          if [[ "${{ github.head_ref }}" =~ ^release/ ]]; then
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ Release branch detected: ${{ github.head_ref }}"
          else
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "ğŸ” Regular branch detected: ${{ github.head_ref }}"
          fi

  # Initialize build pipeline check
  start-check:
    name: ğŸ—ï¸ Initialize Build Pipeline
    runs-on: ubuntu-latest
    needs: check-release
    steps:
      - name: Create CI build check
        run: |
          if [[ "${{ needs.check-release.outputs.is-release }}" == "true" ]]; then
            summary="Release branch - validating release artifacts"
            text="Checking for git tags and changelog instead of full build"
          else
            summary="Building affected packages and running tests"
            text="View detailed build logs and individual job status"
          fi

          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            --field name="âœ… CI Build" \
            --field head_sha=${{ github.event.pull_request.head.sha }} \
            --field status="in_progress" \
            --field details_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --field summary="$summary" \
            --field text="$text"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Release branch validation (lightweight)
  validate-release:
    name: âœ… Validate Release
    runs-on: ubuntu-latest
    needs: [check-release, start-check]
    if: needs.check-release.outputs.is-release == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate release artifacts
        run: |
          echo "ğŸ” Validating release branch: ${{ github.head_ref }}"

          # Check for git tags
          TAGS=$(git tag --points-at HEAD)
          if [ -n "$TAGS" ]; then
            echo "âœ… Found git tags: $TAGS"
          else
            echo "âŒ No git tags found on HEAD commit"
            exit 1
          fi

          # Check for recent changelog updates
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          if echo "$CHANGED_FILES" | grep -q "CHANGELOG.md"; then
            echo "âœ… Changelog updated in this commit"
          else
            echo "âŒ No changelog updates found"
            exit 1
          fi

          # Check for version bump in package.json files
          if echo "$CHANGED_FILES" | grep -q "package.json"; then
            echo "âœ… Package version files updated"
          else
            echo "âŒ No package.json updates found"
            exit 1
          fi

          echo "âœ… Release validation passed"

  # Phase 1: Detection (only for non-release branches)
  detect-affected:
    name: ğŸ” Detect Affected Packages
    needs: [check-release, start-check]
    if: needs.check-release.outputs.is-release == 'false'
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.detect.outputs.packages }}
      has-packages: ${{ steps.detect.outputs.has-packages }}
      package-count: ${{ steps.detect.outputs.package-count }}
      package-groups: ${{ steps.detect.outputs.package-groups }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Detect affected packages
        id: detect
        uses: ./.github/actions/detect-affected

  # Phase 2: Validation (Parallel per Package) - only for non-release branches
  lint:
    name: ğŸ” Lint (${{ matrix.package }})
    needs: [check-release, detect-affected]
    if: needs.check-release.outputs.is-release == 'false' && needs.detect-affected.outputs.has-packages == 'true'
    strategy:
      matrix:
        package: ${{ fromJSON(needs.detect-affected.outputs.packages) }}
      fail-fast: false
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          package-group: ${{ fromJSON(needs.detect-affected.outputs.package-groups)[matrix.package] }}
          package-name: ${{ matrix.package }}

      - name: Run lint for ${{ matrix.package }}
        run: |
          echo "ğŸ” Linting ${{ matrix.package }}..."
          nx lint ${{ matrix.package }}

  test:
    name: ğŸ§ª Test (${{ matrix.package }})
    needs: [check-release, detect-affected]
    if: needs.check-release.outputs.is-release == 'false' && needs.detect-affected.outputs.has-packages == 'true'
    strategy:
      matrix:
        package: ${{ fromJSON(needs.detect-affected.outputs.packages) }}
      fail-fast: false
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          package-group: ${{ fromJSON(needs.detect-affected.outputs.package-groups)[matrix.package] }}
          package-name: ${{ matrix.package }}

      - name: Run tests for ${{ matrix.package }}
        run: |
          echo "ğŸ§ª Testing ${{ matrix.package }}..."
          nx test ${{ matrix.package }}

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}
          path: coverage/
          retention-days: 1

  # Phase 3: Build (Parallel per Package) - only for non-release branches
  build:
    name: ğŸ—ï¸ Build (${{ matrix.package }})
    needs: [check-release, detect-affected, lint, test]
    if: needs.check-release.outputs.is-release == 'false' && needs.detect-affected.outputs.has-packages == 'true'
    strategy:
      matrix:
        package: ${{ fromJSON(needs.detect-affected.outputs.packages) }}
      fail-fast: false
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace
        with:
          package-group: ${{ fromJSON(needs.detect-affected.outputs.package-groups)[matrix.package] }}
          package-name: ${{ matrix.package }}

      - name: Build ${{ matrix.package }}
        run: |
          echo "ğŸ—ï¸ Building ${{ matrix.package }}..."
          nx build ${{ matrix.package }}

      - name: Upload build artifacts for release
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.package }}
          path: dist/packages/${{ matrix.package }}
          retention-days: 3
          if-no-files-found: error

  # Summary and final check update
  summary:
    name: âœ… Build Status
    needs: [check-release, start-check, detect-affected, lint, test, build, validate-release]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check build status and update final check
        run: |
          # Determine overall result based on branch type
          if [[ "${{ needs.check-release.outputs.is-release }}" == "true" ]]; then
            # Release branch validation
            if [[ "${{ needs.validate-release.result }}" == "success" ]]; then
              conclusion="success"
              echo "âœ… Release validation completed successfully"
              summary="Release branch validation passed"
              text="Git tags, changelog, and version updates validated"
            else
              conclusion="failure"
              echo "âŒ Release validation failed"
              summary="Release branch validation failed"
              text="Missing git tags, changelog updates, or version bumps"
            fi
          else
            # Regular branch build validation
            if [[ "${{ needs.detect-affected.result }}" == "success" && 
                  ("${{ needs.lint.result }}" == "success" || "${{ needs.lint.result }}" == "skipped") && 
                  ("${{ needs.test.result }}" == "success" || "${{ needs.test.result }}" == "skipped") && 
                  ("${{ needs.build.result }}" == "success" || "${{ needs.build.result }}" == "skipped") ]]; then
              conclusion="success"
              echo "âœ… Build pipeline completed successfully"
              summary="CI build completed with success"
              text="All affected packages passed lint, test, and build"
            else
              conclusion="failure" 
              echo "âŒ Build pipeline failed"
              summary="CI build completed with failure"
              text="One or more packages failed lint, test, or build"
            fi

            if [[ "${{ needs.detect-affected.outputs.has-packages }}" == "true" ]]; then
              echo "ğŸ“¦ Packages: ${{ needs.detect-affected.outputs.packages }}"
            else
              echo "â„¹ï¸ No affected packages found - documentation or config changes only"
            fi
          fi

          # Update the check run
          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            --field name="âœ… CI Build" \
            --field head_sha=${{ github.event.pull_request.head.sha }} \
            --field status="completed" \
            --field conclusion="$conclusion" \
            --field details_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --field summary="$summary" \
            --field text="$text"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
