name: ğŸš€ Publish Packages

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number'
        required: false
        type: string
      head_ref:
        description: 'Head branch reference'
        required: false
        type: string
      head_sha:
        description: 'Head commit SHA'
        required: false
        type: string
      base_ref:
        description: 'Base branch reference'
        required: false
        type: string

jobs:
  release:
    name: Tag and Publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Extract release info
        id: extract
        run: |
          # Extract package and version from merge commit message
          # Expected format: "ğŸš€ Release Request for package-name@version - ..."
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          echo "ğŸ“ Commit message: $COMMIT_MESSAGE"

          # Extract package name and version from commit message
          EXTRACT_RESULT=$(echo "$COMMIT_MESSAGE" | sed -n 's/.*for \([^@]*\)@\([0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\).*/\1|\2/p')

          if [ -n "$EXTRACT_RESULT" ]; then
            PACKAGE_NAME=$(echo "$EXTRACT_RESULT" | cut -d'|' -f1)
            VERSION=$(echo "$EXTRACT_RESULT" | cut -d'|' -f2)
            TAG_NAME="${PACKAGE_NAME}@${VERSION}"
            
            echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
            
            echo "ğŸ“¦ Package: $PACKAGE_NAME"
            echo "ğŸ·ï¸ Version: $VERSION (from merge commit message)"
            echo "ğŸ·ï¸ Tag: $TAG_NAME"
          else
            echo "âŒ Could not extract package and version from commit message"
            echo "Expected format: 'ğŸš€ Release Request for package-name@version - ...'"
            echo "Actual message: $COMMIT_MESSAGE"
            exit 1
          fi

      - name: Download build artifacts
        uses: dawidd6/action-download-artifact@v11
        with:
          name: build-${{ steps.extract.outputs.package }}
          workflow: build.yml
          path: dist/packages/${{ steps.extract.outputs.package }}

      - name: Verify artifacts exist
        run: |
          if [ ! -d "dist/packages/${{ steps.extract.outputs.package }}" ]; then
            echo "âŒ Build artifacts not found for ${{ steps.extract.outputs.package }}"
            exit 1
          fi

          echo "âœ… Build artifacts verified for ${{ steps.extract.outputs.package }}"
          ls -la "dist/packages/${{ steps.extract.outputs.package }}"

      - name: Create and push tag
        run: |
          git tag "${{ steps.extract.outputs.tag }}"
          git push origin "${{ steps.extract.outputs.tag }}"
          echo "âœ… Tag ${{ steps.extract.outputs.tag }} created and pushed"

      - name: Publish to registries
        run: |
          echo "ğŸ“¦ Publishing ${{ steps.extract.outputs.package }}@${{ steps.extract.outputs.version }}..."
          nx run ${{ steps.extract.outputs.package }}:nx-release-publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup release branch
        run: |
          BRANCH_NAME="release/${{ steps.extract.outputs.package }}"
          echo "ğŸ§¹ Deleting release branch: $BRANCH_NAME"
          git push origin --delete "$BRANCH_NAME" || echo "â„¹ï¸ Branch $BRANCH_NAME already deleted or doesn't exist"
          echo "âœ… Release branch cleanup completed"
