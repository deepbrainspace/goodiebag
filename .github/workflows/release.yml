name: 🚀 Release

on:
  push:
    branches:
      - main
    paths:
      - 'packages/*/package.json'
      - 'packages/*/CHANGELOG.md'

jobs:
  release:
    name: Tag and Publish
    runs-on: ubuntu-latest
    # Only run if this push came from merging a release/* branch
    if: contains(github.event.head_commit.message, 'release(') && contains(github.event.head_commit.message, 'prepare v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Extract release info
        id: extract
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ $COMMIT_MSG =~ release\(([^)]+)\):\ prepare\ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            PACKAGE_NAME="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
            TAG_NAME="${PACKAGE_NAME}@${VERSION}"
            
            echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
            
            echo "📦 Package: $PACKAGE_NAME"
            echo "🏷️ Version: $VERSION"  
            echo "🏷️ Tag: $TAG_NAME"
          else
            echo "❌ Could not extract release info from commit message: $COMMIT_MSG"
            exit 1
          fi

      - name: Download CI build artifacts
        uses: dawidd6/action-download-artifact@v11
        with:
          name: build-${{ steps.extract.outputs.package }}
          workflow: ci.yml
          path: dist/packages/${{ steps.extract.outputs.package }}

      - name: Verify artifacts exist
        run: |
          if [ ! -d "dist/packages/${{ steps.extract.outputs.package }}" ]; then
            echo "❌ Build artifacts not found for ${{ steps.extract.outputs.package }}"
            exit 1
          fi
          
          echo "✅ Build artifacts verified for ${{ steps.extract.outputs.package }}"
          ls -la "dist/packages/${{ steps.extract.outputs.package }}"

      - name: Create and push tag
        run: |
          git tag "${{ steps.extract.outputs.tag }}"
          git push origin "${{ steps.extract.outputs.tag }}"
          echo "✅ Tag ${{ steps.extract.outputs.tag }} created and pushed"

      - name: Publish to registries
        run: |
          echo "📦 Publishing ${{ steps.extract.outputs.package }}@${{ steps.extract.outputs.version }}..."
          nx run ${{ steps.extract.outputs.package }}:nx-release-publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  no-release:
    name: No release detected
    runs-on: ubuntu-latest
    if: ${{ !(contains(github.event.head_commit.message, 'release(') && contains(github.event.head_commit.message, 'prepare v')) }}
    
    steps:
      - name: Skip release
        run: |
          echo "ℹ️ Push to main detected but not from a release branch merge."
          echo "Commit message: ${{ github.event.head_commit.message }}"
          echo "No release actions will be performed."