name: üöÄ Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  release:
    name: Tag and Publish
    runs-on: ubuntu-latest
    # Only run if PR was merged and came from a release/* branch
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Extract release info
        id: extract
        run: |
          # Extract package from release branch name (Release Please strategy)
          # Expected format: "release/package-name"
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          if [[ $BRANCH_NAME =~ release/(.+) ]]; then
            PACKAGE_NAME="${BASH_REMATCH[1]}"
            
            echo "üì¶ Package: $PACKAGE_NAME"
            
            # Extract version using NX (works across all project types)
            echo "üîç Detecting version using NX for $PACKAGE_NAME"
            
            # Use NX to detect the current version (works for all project types)
            NX_OUTPUT=$(nx show project $PACKAGE_NAME --json 2>/dev/null || echo "{}")
            
            # Alternative: Extract version from changelog file (created by NX release)
            if [ "$PACKAGE_NAME" = "goodiebag" ]; then
              CHANGELOG_PATH="CHANGELOG.md"
            else
              CHANGELOG_PATH="packages/$PACKAGE_NAME/CHANGELOG.md"
            fi
            
            if [ -f "$CHANGELOG_PATH" ]; then
              # Extract the most recent version from changelog (first version heading)
              VERSION=$(grep -m 1 "^## \[" "$CHANGELOG_PATH" | sed 's/^## \[\([^]]*\)\].*/\1/' || echo "")
              
              if [ -z "$VERSION" ]; then
                echo "‚ùå Could not extract version from changelog: $CHANGELOG_PATH"
                exit 1
              fi
              
              TAG_NAME="${PACKAGE_NAME}@${VERSION}"
              
              echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
              
              echo "üè∑Ô∏è Version: $VERSION (from $CHANGELOG_PATH)"
              echo "üè∑Ô∏è Tag: $TAG_NAME"
            else
              echo "‚ùå Could not find changelog at: $CHANGELOG_PATH"
              echo "Release branch should have been created with changelog by NX release"
              exit 1
            fi
          else
            echo "‚ùå Could not extract package name from branch: $BRANCH_NAME"
            echo "Expected format: release/package-name"
            exit 1
          fi

      - name: Download build artifacts
        uses: dawidd6/action-download-artifact@v11
        with:
          name: build-${{ steps.extract.outputs.package }}
          workflow: build.yml
          path: dist/packages/${{ steps.extract.outputs.package }}

      - name: Verify artifacts exist
        run: |
          if [ ! -d "dist/packages/${{ steps.extract.outputs.package }}" ]; then
            echo "‚ùå Build artifacts not found for ${{ steps.extract.outputs.package }}"
            exit 1
          fi

          echo "‚úÖ Build artifacts verified for ${{ steps.extract.outputs.package }}"
          ls -la "dist/packages/${{ steps.extract.outputs.package }}"

      - name: Create and push tag
        run: |
          git tag "${{ steps.extract.outputs.tag }}"
          git push origin "${{ steps.extract.outputs.tag }}"
          echo "‚úÖ Tag ${{ steps.extract.outputs.tag }} created and pushed"

      - name: Publish to registries
        run: |
          echo "üì¶ Publishing ${{ steps.extract.outputs.package }}@${{ steps.extract.outputs.version }}..."
          nx run ${{ steps.extract.outputs.package }}:nx-release-publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  no-release:
    name: No release detected
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged != true || !startsWith(github.event.pull_request.head.ref, 'release/')

    steps:
      - name: Skip release
        run: |
          echo "‚ÑπÔ∏è PR detected but not a merged release branch PR."
          echo "PR merged: ${{ github.event.pull_request.merged }}"
          echo "Head ref: ${{ github.event.pull_request.head.ref }}"
          echo "No release actions will be performed."
