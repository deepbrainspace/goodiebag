name: 🚀 On PR Merged

on:
  pull_request:
    types: [closed]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    if: 'github.event.pull_request.merged == true'
    steps:
      - name: Route to appropriate workflow
        run: |
          if [[ ! "${{ github.head_ref }}" =~ ^release/ ]]; then
            echo "📝 Triggering prepare release workflow for merged PR"
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/create-release-prs.yml/dispatches \
              -d '{
                "ref": "main",
                "inputs": {
                  "pr_number": "${{ github.event.pull_request.number }}",
                  "head_ref": "${{ github.head_ref }}",
                  "head_sha": "${{ github.event.pull_request.head.sha }}",
                  "base_ref": "${{ github.base_ref }}"
                }
              }'
          else
            echo "🚀 Triggering release publish workflow for merged release PR"
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/publish-packages.yml/dispatches \
              -d '{
                "ref": "main",
                "inputs": {
                  "pr_number": "${{ github.event.pull_request.number }}",
                  "head_ref": "${{ github.head_ref }}",
                  "head_sha": "${{ github.event.pull_request.head.sha }}",
                  "base_ref": "${{ github.base_ref }}"
                }
              }'
          fi
